name: PR Status Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-status-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write

jobs:
  mark-checking:
    name: Set Checking Status
    runs-on: ubuntu-latest
    # Don't run on fork PRs (they can't write labels)
    if: github.event.pull_request.head.repo.full_name == github.repository
    timeout-minutes: 5
    steps:
      - name: Update PR status label
        uses: actions/github-script@v7
        with:
          retries: 3
          retry-exempt-status-codes: 400,401,403,404,422
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const statusLabels = ['ðŸ”„ Checking', 'âœ… Ready for Review', 'âŒ Checks Failed'];

            console.log(`::group::PR #${prNumber} - Setting status to Checking`);

            // Remove old status labels (parallel for speed)
            const removePromises = statusLabels.map(async (label) => {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: prNumber,
                  name: label
                });
                console.log(`  âœ“ Removed: ${label}`);
              } catch (e) {
                if (e.status !== 404) {
                  console.log(`  âš  Could not remove ${label}: ${e.message}`);
                }
              }
            });

            await Promise.all(removePromises);

            // Add checking label
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ['ðŸ”„ Checking']
              });
              console.log(`  âœ“ Added: ðŸ”„ Checking`);
            } catch (e) {
              // Label might not exist - create helpful error
              if (e.status === 404) {
                core.warning(`Label 'ðŸ”„ Checking' does not exist. Please create it in repository settings.`);
              }
              throw e;
            }

            console.log('::endgroup::');
            console.log(`âœ… PR #${prNumber} marked as checking`);
